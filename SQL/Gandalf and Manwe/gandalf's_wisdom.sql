-- **************************************************************************************************************
--     Require Gandalf's Wisdom
-- **************************************************************************************************************

-- *..,.*,....((#(/                  .,,,,..,................                      
-- (.....,**.*(/##(                  .,,,,,,,................                      
-- *..,/*//(*#((%#/              .*(##(%@%*,,,...............                      
-- ,...///*/####/%/           ,(#&(((%%&&%@@&&/,,,..........                       
-- /,.**/((((#(/#(/         .#%& ,///(%&&&&(/&@@#,...........                      
-- /,,*,,,/(///((/*       .*##@*//(##%%%&&&&&(@@@&,.,........                      
-- *..,,,*,,,,..,.,       .(#%@,**/((##%%#%%&&%@@@&.                               
-- *, *,.....             /((&@.*,,*/((&(, ,.*/@@@@*.                              
-- ,  . ..              .*/#(%@... ,.,,#&((/#(*@@@@@,..... ...                     
-- ,   .                ./(#((@//,/*,**#%%%((%(@@@@@&,. ..,*,..   ...              
-- , .                 .*((#((@*.,,*,,,*%#/#%##@@@@@@#.   ..,..   ....             
-- ,                   .(((%#%#%..,**(//((#&%(%&&@@@@@**,...,,..  ......           
-- .                   ,/((#%&#&,,,/*,.,*. //#%#&@@@@@/*,,,,**,,,...........       
-- ,  .                ,/(##%&%@//(((///*(#**#&(&@@@@@//*,,**,,,/*,.,,*,,,.....    
-- .                  .**(/#%%%@/(/((((/(#%#/(@#&&@@@@#//**/(//******,,..........  
-- .                  .*///(#(#&*(#((((######*%%&%@@@@&#%#/*/((**///***,,,.......  
-- .              ..,,***///(,*(&/((((#####%%%,&//&@@@@&#%@@@@@@%##(//(/,.,,*,.... 
--             ,**/*****((((/,*..*/###%(%#&@@&#,((%%@@@@&&@@@@@@@@@@(((((/***,.   .
--  .        ./((*//**///(/#(*/..,,(##%%%&@@@@@.###%&@@@&@@@@@@@@@@@%(((((/*,*,... 
--          ,/((/(*//*/((##%(,#,/###(#%&&@@@@@@*/@%&%@@@&@@@@@@@@@@@@&(////**,.... 
--         **((#&**(///(%(%##((##%%%%%&#@@@@@@@@.@@@@@@@@@@@@@@@@@@@@@@////,,,,,...
--        */#&((#&,/(/(/(%#&%&&&#&@@@%&&@@@@@@@@.@@@@@@@@@@@@@@@@@@@@@@@#/(/*,.....
--       *//((%%/&&,(#%#(%/%@&@@&@@@&&&#&@@@@@@@.  (@@@@@&@@@@@@@@@@@@@@@@/(/*,....
--      ,((((((%&@@*#%%&*###@@@@@@@@@%@&@@@@@%,*/(#(/#@@@@@@@@@@@@@@@@@@@@@@/*,... 
--     ./#%##(#&%&@@@(/@//#%&@@@@&@@@&%&@@@@@,,. .,*/(/ @@@@@@@@@@@@@&@@@@@@@@#    
--     /(((/%@@@@@@@@@%@//##&@&&&&@@@%#&&@@@,,.  ,//,,*/@@@@@&@@@@@@@@&@@@@@@@@@   
--    /%%&&&@@@@(&@@@&@&**(#&@&%%&&@&&&@@@@,*  .*, .*/(@@@@@&&@%@@@@@@@@@@@@@@@@,  
--     (##@@@@@@@@@@&&%#*/(#%&%%##%%&%#&%%&%#.,*...,,&&@@@@@@@@@@@@&@@&&@@&@@@@@@  
--     *((/(#&@%@@@@&&%%%%#(###########(###(((( . *((((%&&@@@@/@@@@&@@@@@&@@@@&@@@ 
--      /*(((##%&%##%%%&%(/%(#((((/(//((((((//*,*,,.,,**/%(#&/#@@&&%@@@@@@@@@@@@@@#
--      */(##(((((%&%%(&%&%&%#%%%%#%#(///(//(##(#%#&/**/((//##&%/##%&@@&@@@@@@@&%# 
--      //****/(((/(/(#%#(&(&&&&&&&%&&&%#@&#&@@&%@%&,. ..,*,/(#((///%@@&%##%#(#/   


-- **************************************************************************************************************
--     SQL Basics: Using LATERAL JOIN To Get Top N per Group
--     https://www.codewars.com/kata/5820176255c3d23f360000a9/train/sql
--     Status: NOT SOLVED
-- **************************************************************************************************************

-- left join posts with categories and rank by views
with post_categories as (
select 
  row_number() over( partition by c.category order by views desc) as "rank",
  c.id as category_id,
  c.category as category,
  p.title,
  p.views,
  p.id as post_id
from posts as p
left join categories as c
on p.category_id = c.id
)

-- produce ranked table and order by specified columns
select 
  category_id,
  category,
  title,
  views,
  post_id
from post_categories
where (rank < 3) or (rank is null)
order by
category asc,
views desc,
post_id asc

